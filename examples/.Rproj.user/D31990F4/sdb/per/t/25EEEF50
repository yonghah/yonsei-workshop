{
    "collab_server" : "",
    "contents" : "library(httr)\nlibrary(ggplot2)\nlibrary(dplyr)\n\nrvc <- ''\nurl <- ''\n\ngetRevDates <- function(title, rvid) {\n  pl <- list(\n    action='query', \n    prop='revisions', \n    titles=title,\n    format='json',\n    rvlimit='500')\n  if (rvid != '') {\n    pl <- c(pl, rvcontinue=rvid)\n  }\n  r <- POST(url, body = pl)\n  res <- content(r)\n  rev <- res$query$pages[[1]]$revisions\n  date <- unlist(lapply(rev, function(x) x$timestamp))\n  date_posix <- as.POSIXct(strptime(date, \"%Y-%m-%dT%H:%M:%SZ\", tz=\"UTC\"))\n  rvc <<- res$continue$rvcontinue\n  return(date)\n}\n\ngetRevisionHistory <- function(title, lang){\n  results <- vector()\n  rvc <<-''\n  url <<- paste(\"https://\", lang, \".wikipedia.org/w/api.php\", sep = \"\")\n  # res$continue$rvcontinue가 없을 때까지 반복\n  while(!is.null(rvc)) {\n    t <- getRevDates(title, rvc)\n    results <- c(results, t)\n  }\n  date_posixct <-  as.POSIXct(strptime(results, \"%Y-%m-%dT%H:%M:%SZ\", tz=\"UTC\"))\n  rt <- as.data.frame(date_posixct, date)\n  rt <- rt %>% \n    mutate(date = as.Date(date_posixct)) %>%\n    mutate(title = title)\n  return(rt)\n}\n\n# titles <- c('Seoul', 'Tokyo', 'Beijing', 'Shanghai', 'Hong_Kong', 'Singapore', 'Taipei')\ntitles <- c('New York City', 'London', 'Tokyo', 'Paris', 'Hong_Kong', 'Los_Angeles', 'Seoul', \n            'Osaka', 'Shanghai', 'Chicago', 'Moscow', 'Singapore', 'Beijing', 'Brussels', 'Berlin')\n# titles <- c('Girls\\'_Generation', 'Kara_(South_Korean_band)', 'Wonder_Girls', \n#             '2NE1', 'F(x)_(band)', 'Secret_(South_Korean_band)',\n#             'Sistar', 'Miss_A', 'Girl\\'s_Day',\n#             'AOA_(band)', 'EXID', 'Apink', \n#             'GFriend', 'Red_Velvet_(band)', 'Mamamoo', 'Twice_(band)',\n#             'Lovelyz'\n#             )\n\n# titles <- c('FC_Barcelona', 'Real_Madrid_C.F.', 'Atlético_Madrid', 'FC_Bayern Munich', \n#             'Juventus_F.C.', 'Manchester_United_F.C.', 'Arsenal_F.C.', 'Manchester_City_F.C.', 'Chelsea F.C.', 'Liverpool_F.C.',\n#             'Borussia_Dortmund', 'A.C._Milan', 'Tottenham_Hotspur_F.C.')\n\ndatalist <- list()\ni <- 1\nfor (title in titles) {\n  print(title)\n  datalist[[i]] <- getRevisionHistory(title, \"en\")\n  i <- i + 1\n}\nrt <- bind_rows(datalist)\n\n# horizontal chart\nbandh <- 200\nrtg <- rt %>%\n  group_by(p=cut(date_posixct, \"1 month\"), title) %>%\n  summarise(count=n()) %>%\n  mutate(level=count %/% bandh, \n         rem = count %% bandh,\n         date = as.Date(p))\n\nmax(rtg$count)\nmax(rtg$level)\n\nalphaStep = 1 / (max(rtg$level) + 1)\n\nggplot(rtg, aes(x=date)) +\n  geom_bar(aes(y=bandh, alpha = level), fill='darkred', stat='identity') +\n  scale_alpha_continuous(range = c(alphaStep, 1)) +\n  geom_bar(aes(y=rem), alpha = min(1, alphaStep), fill='darkred', stat='identity') +\n  scale_x_date(date_breaks = \"3 month\", date_labels = \"%Y-%m\") +\n  ylab(NULL) +\n  facet_grid(title ~.) +\n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 60, hjust = 1),\n        axis.text.y = element_blank(),\n        legend.position=\"none\", \n        strip.text.y = element_text(angle=0),\n        strip.background = element_rect(fill = \"white\")) \n\nggplot(rt, aes(x=date)) +\n  geom_histogram(binwidth=20) +\n  facet_grid(title ~.) \n\n# # histogram\n# ggplot(rt, aes(x=date)) + \n#   geom_histogram(binwidth=10, alpha = 6/10, aes(y=..count..), fill=\"purple\") +\n#   scale_x_date(date_breaks = \"1 year\", date_labels = \"%Y\") +\n#   # annotate(\"text\", x = as.Date(\"2015-01-15\"), y = 80, label = \"Glass Bead\") + # 유리구슬\n#   # annotate(\"text\", x = as.Date(\"2015-07-23\"), y = 50, label = \"Me gustas tu\") + # 오늘부터 우리는\n#   # annotate(\"text\", x = as.Date(\"2016-01-25\"), y = 180, label = \"Rough\") + # 시간을 달려서\n#   # annotate(\"text\", x = as.Date(\"2016-07-11\"), y = 100, label = \"NAVILLERA\") + #너 그리고 나\n#   labs(title = \"Number of revisions in the Wikipedia page\") +\n#   ylab(\"Count in 10 days\") +\n#   facet_grid(title ~.) +\n#   theme(axis.text.x = element_text(angle = 60, hjust = 1)) \n\n\n",
    "created" : 1476900610519.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1663171859",
    "id" : "25EEEF50",
    "lastKnownWriteTime" : 1478204452,
    "last_content_update" : 1478204452132,
    "path" : "C:/WORK/repo/yonsei-workshop/examples/wiki.R",
    "project_path" : "wiki.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}